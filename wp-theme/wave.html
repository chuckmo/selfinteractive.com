<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
		<title>HTML5 Wave Physics (based on Yugo Nakamura's classic effect)</title>
		
		<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
		
		<style>
			* { margin:0; padding:0; background-color:#151515; }
		</style>
		
		<canvas id="stage" width="400" height="400">
			<p>Your browser doesn't support canvas.</p>
		</canvas>
		
		<script type="text/javascript">
			
			// requestAnimationFrame polyfill
			(function() {
			    var lastTime = 0;
			    var vendors = ['webkit', 'moz'];
			    for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
			        window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
			        window.cancelAnimationFrame =
			          window[vendors[x]+'CancelAnimationFrame'] || window[vendors[x]+'CancelRequestAnimationFrame'];
			    }

			    if (!window.requestAnimationFrame)
			        window.requestAnimationFrame = function(callback, element) {
			            var currTime = new Date().getTime();
			            var timeToCall = Math.max(0, 16 - (currTime - lastTime));
			            var id = window.setTimeout(function() { callback(currTime + timeToCall); },
			              timeToCall);
			            lastTime = currTime + timeToCall;
			            return id;
			        };

			    if (!window.cancelAnimationFrame)
			        window.cancelAnimationFrame = function(id) {
			            clearTimeout(id);
			        };
			}());



			/*
			 * @author stephen burgess (steve@flashmonkey.co.uk)
			 * based on AS2 wave by Paul Lewis (http://www.anygivenfriday.com)
			 * which was based on Yugo Nakamura's original (http://yugop.com/)
			 */
			
			// TODO modularize
		
			var stage = document.getElementById('stage');
			
			var color = "#fff";
			var springs = [];
			var storeY;
			var extend = 400; // TODO this should be calculated
			var fK = .5;
			var dampeningConstant = 1.01;
			var elasticityConstant = 1;
			var shoveStrength = 3;
			var particles = [];
			var currentDrag = null;
			var bounceRadius = 50;
			var bounceDampening = 1.5;
			var bounceTop;
			var bounceBottom;
			var mouseX = 0;
			var mouseY = 0;
			var stageWidth = $(document).width();
			var stageHeight = $(document).height();
			stage.width = stageWidth;
			stage.height = stageHeight;

			var fpsAdjust;
			
			
			
			
			function generate()
			{
				var total = Math.ceil(stageWidth / 100);
				springs = [];
				particles = [];
				
				var space = (stageWidth + extend) / total;
				var xpos = (space * .5) - (extend * .5);
				var ypos = stageHeight * .5;

				// set bounce y's
				bounceTop = ypos - bounceRadius;
				bounceBottom = ypos + bounceRadius;
				
				for(var i = 0; i < total; i++)
				{
					var particle = {};
					particle.x = particle.xpos = xpos;
					particle.y = particle.ypos = particle.origY = ypos;
					particle.ay = 0;
					particle.vy = 0;
					particle.mass = 1;
					particles[particles.length] = particle;
					
					xpos += space;
				}
				
				
				storeY = mouseY;
				for(var u = 0; u < particles.length-1; u++) springs.push({iLengthY:(particles[u+1].y - particles[u].y)});
			}
			
			function randomShove(){

				// pick a particle
				var i = Math.floor(Math.random()*particles.length);

				particles[i].vy = bounceRadius * shoveStrength;

			}
			
			function mouseMove()
			{
				var particle = null;
				var smallestDist = Infinity;
				var target = null;
				
				var j = particles.length;
				while(--j > -1)
				{
					var dx = mouseX - particles[j].x;
					var dy = mouseY - particles[j].y;
					var dist = Math.sqrt(dx * dx + dy * dy);
					
					if(dist < smallestDist)
					{
						particle = particles[j];
						smallestDist = dist;
						target = j;
					}
				}
				
				if(particle && mouseY > particle.y)
				{
					var speed = mouseY - storeY;
					
					particles[target - 2].vy = speed / 3 * elasticityConstant;
					particles[target - 1].vy = speed / 2 * elasticityConstant;
					particles[target].vy = speed / elasticityConstant;
					particles[target + 1].vy = speed / 2 * elasticityConstant;
					particles[target + 2].vy = speed / 3 * elasticityConstant;
				
					storeY = mouseY;
				}
			}
			
			function moveParticles(){

				for(var u = particles.length-1; u >= 0; --u)
				{
					var fExtensionY = 0;
					var fForceY = 0;
				
					if(u > 0)
					{
						fExtensionY = particles[u-1].y - particles[u].y - springs[u-1].iLengthY;
						fForceY += -fK * fExtensionY;
					}
					
					if(u < particles.length-1)
					{
						fExtensionY = particles[u].y - particles[u+1].y - springs[u].iLengthY;
						fForceY += fK * fExtensionY;
					}
					
					fExtensionY = particles[u].y - particles[u].origY;
					fForceY += fK/15 * fExtensionY;
					
					particles[u].ay = -fForceY/particles[u].mass;
					particles[u].vy	+= particles[u].ay;
					particles[u].ypos += particles[u].vy * fpsAdjust;

					// maybe bounce
					if(particles[u].ypos < bounceTop){

						// flip velocity dir
						particles[u].vy *= -1;

						particles[u].ypos = bounceTop + (bounceTop - particles[u].ypos);
						particles[u].ya /= bounceDampening;

					}else if(particles[u].ypos > bounceBottom){

						// flip velocity dir
						particles[u].vy *= -1;

						particles[u].ypos = bounceBottom - (particles[u].ypos - bounceBottom);
						particles[u].ya /= bounceDampening;
					}

					particles[u].vy /= dampeningConstant;
				}
			}
			
			function render()
			{
				
				context.clearRect(0, 0, stageWidth, stageHeight);
				context.fillStyle = color;
				context.beginPath();
				
				for(u = 0; u < particles.length; u++)
				{
					if(u==0)
					{
						context.moveTo(particles[u].xpos+(particles[u+1].xpos-particles[u].xpos)/2,particles[u].ypos+(particles[u+1].ypos-particles[u].ypos)/2);
					}
					else if(u < particles.length-1)
					{
						context.lineTo(particles[u].xpos,particles[u].ypos);
					}
					particles[u].x = particles[u].xpos;
					particles[u].y = particles[u].ypos;
				}
				
				context.lineTo(stageWidth+50, stageHeight+50);
				context.lineTo(-50, stageHeight+50);
				context.lineTo(-50, stageHeight/2);
				context.closePath();
				context.fill();
			}
			
			function getMouseXY(e)
			{
  				if(IE)
  				{
  					mouseX = event.clientX + document.body.scrollLeft
  					mouseY = event.clientY + document.body.scrollTop
  				}
  				else
  				{
  					mouseX = e.pageX
  					mouseY = e.pageY
  				}  
  				
  				if(mouseX < 0) {mouseX = 0;}
  				if(mouseY < 0) {mouseY = 0;}  
  				
  				mouseMove();
  				
  				return true;
			}
			
			var drawingCanvas = document.getElementById('stage');

			// if canvas is supported, let's do this!
			if(drawingCanvas.getContext)
			{
				var context = drawingCanvas.getContext('2d');

				// setup the particles
				generate();
				window.onresize = function(event)
				{
					stage.width = 10;
					stage.height = 10;
					stageWidth = $(document).width();
					stageHeight = $(document).height();
					stage.width = stageWidth;
					stage.height = stageHeight;
					
					generate();
				}

				// setup animation loops
				var lastFrameTime = new Date().getTime();
				(function animloop(){
					var newTime = new Date().getTime();

					fpsAdjust = (newTime - lastFrameTime)/1000;
					lastFrameTime = newTime;

					moveParticles();
				  render();

				  window.requestAnimationFrame(animloop);
				})();

				// setup random shove to keep the wave dancing
				setInterval(randomShove, 2000);
				randomShove();

				// listen for mouse movement
				var IE = document.all ? true : false;
				if(!IE) document.addEventListener(Event.MOUSEMOVE, getMouseXY, false);
				document.onmousemove = getMouseXY;
			}
			
		</script>

		
	</head>
</html>
